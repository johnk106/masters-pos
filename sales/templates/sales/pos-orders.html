{%extends 'landing/base.html'%}
{%load static%}
{%load humanize%}

{%block head%}
<title>POS orders</title>
{%endblock%}


{%block body%}
<div class="page-wrapper">
	<div class="content">
		<div class="page-header">
			<div class="add-item d-flex">
				<div class="page-title">
					<h4>POS Orders</h4>
					<h6>Manage Your pos orders</h6>
				</div>
			</div>
			<ul class="table-top-head">
				<li>
					<a data-bs-toggle="tooltip" data-bs-placement="top" title="Pdf" href="{{ export_pdf_url }}"><img
							src="{%static 'landing/assets/img/icons/pdf.svg'%}" alt="img"></a>
				</li>
				<li>
					<a data-bs-toggle="tooltip" data-bs-placement="top" title="Excel" href="{{ export_excel_url }}"><img
							src="{%static 'landing/assets/img/icons/excel.svg'%}" alt="img"></a>
				</li>
				<li>
					<a data-bs-toggle="tooltip" data-bs-placement="top" title="Refresh"><i
							class="ti ti-refresh"></i></a>
				</li>
				<li>
					<a data-bs-toggle="tooltip" data-bs-placement="top" title="Collapse" id="collapse-header"><i
							class="ti ti-chevron-up"></i></a>
				</li>
			</ul>
			<!-- <div class="page-btn">
				<a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add-sales-new"><i
						class="ti ti-circle-plus me-1"></i>Add Sales</a>
			</div> -->
		</div>

		<!-- /product list -->
		<div class="card">
			<div class="card-header d-flex align-items-center justify-content-between flex-wrap row-gap-3">
				<div class="search-set">
					<div class="search-input">
						<span class="btn-searchset"><i class="ti ti-search fs-14 feather-search"></i></span>
					</div>
				</div>
				<div class="d-flex table-dropdown my-xl-auto right-content align-items-center flex-wrap row-gap-3">
					<form id="filter-form" method="GET" class="d-flex align-items-center flex-wrap row-gap-3">
						<input type="hidden" name="search" value="{{ search }}">
						
						<!-- Customer Filter -->
						<div class="filter-group me-2">
							<label for="customer-filter" class="visually-hidden">Customer</label>
							<select name="customer" id="customer-filter" class="form-select" style="width: 180px;" aria-label="Select Customer">
								<option value="" disabled {% if not selected_customer %}selected{% endif %}>Select Customer...</option>
								{% for customer in customers %}
								<option value="{{ customer.name }}" {% if selected_customer == customer.name %}selected{% endif %}>
									{{ customer.name }}
								</option>
								{% endfor %}
							</select>
						</div>

						<!-- Status Filter -->
						<div class="filter-group me-2">
							<label for="status-filter" class="visually-hidden">Order Status</label>
							<select name="status" id="status-filter" class="form-select" style="width: 140px;" aria-label="Select Order Status">
								<option value="" disabled {% if not selected_status %}selected{% endif %}>Select Status...</option>
								{% for status_key, status_label in statuses %}
								<option value="{{ status_key }}" {% if status_key == selected_status %}selected{% endif %}>
									{{ status_label }}
								</option>
								{% endfor %}
							</select>
						</div>

						<!-- Payment Status Filter -->
						<div class="filter-group me-2">
							<label for="payment-status-filter" class="visually-hidden">Payment Status</label>
							<select name="payment_status" id="payment-status-filter" class="form-select" style="width: 160px;" aria-label="Select Payment Status">
								<option value="" disabled {% if not selected_payment_status %}selected{% endif %}>Select Payment Status...</option>
								{% for payment_key, payment_label in payment_statuses %}
								<option value="{{ payment_key }}" {% if payment_key == selected_payment_status %}selected{% endif %}>
									{{ payment_label }}
								</option>
								{% endfor %}
							</select>
						</div>

						<!-- Sort By Filter -->
						<div class="filter-group me-2">
							<label for="sort-filter" class="visually-hidden">Sort By</label>
							<select name="sort_by" id="sort-filter" class="form-select" style="width: 170px;" aria-label="Sort Orders By">
								<option value="" disabled {% if not selected_sort %}selected{% endif %}>Sort By...</option>
								<option value="recently_added" {% if selected_sort == 'recently_added' %}selected{% endif %}>Recently Added</option>
								<option value="ascending" {% if selected_sort == 'ascending' %}selected{% endif %}>Ascending (A-Z)</option>
								<option value="descending" {% if selected_sort == 'descending' %}selected{% endif %}>Descending (Z-A)</option>
								<option value="last_month" {% if selected_sort == 'last_month' %}selected{% endif %}>Last Month</option>
								<option value="last_7_days" {% if selected_sort == 'last_7_days' %}selected{% endif %}>Last 7 Days</option>
							</select>
						</div>

						<!-- Filter and Clear buttons -->
						<div class="filter-actions">
							<button type="submit" class="btn btn-primary me-2" aria-label="Apply selected filters">
								<i class="ti ti-filter me-1"></i>Apply Filters
							</button>
							<a href="{% url 'sales:pos-orders' %}" class="btn btn-secondary" aria-label="Clear all filters">
								<i class="ti ti-refresh me-1"></i>Clear Filters
							</a>
						</div>
					</form>
				</div>
			</div>
			<div class="card-body p-0">
				<div class="table-responsive">
					<table class="table datatable">
						<thead class="thead-light">
							<tr>
								<th class="no-sort">
									<label class="checkboxs">
										<input type="checkbox" id="select-all">
										<span class="checkmarks"></span>
									</label>
								</th>
								<th>Customer</th>
								<th>Reference</th>
								<th>Date</th>
								<th>Status</th>
								<th>Grand Total</th>
								<th>Paid</th>
								<th>Due</th>
								<th>Payment Status</th>
								<th>Payment Type</th>
								<th>Biller</th>
								<th></th>
							</tr>
						</thead>
						<tbody class="sales-list">
							{%for order in orders%}
							<tr>
								<td>
									<label class="checkboxs">
										<input type="checkbox">
										<span class="checkmarks"></span>
									</label>
								</td>
								{%if order.customer%}
								<td>
									<div class="d-flex align-items-center">
										<a href="javascript:void(0);" class="avatar avatar-md me-2">
											<img src="{{order.customer.image.url}}" alt="product">
										</a>
										<a href="javascript:void(0);">{{order.customer.name}}</a>
									</div>
								</td>
								{%else%}
								<td>
									<div class="d-flex align-items-center">
										<a href="javascript:void(0);" class="avatar avatar-md me-2">
											<img src="https://imgs.search.brave.com/9a-iE4YQlxsHtJE0iTvKmrY3joy4A1vKGPfnVyYr-NE/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9tZWRp/YS5pc3RvY2twaG90/by5jb20vaWQvMTIx/NDQyODMwMC92ZWN0/b3IvZGVmYXVsdC1w/cm9maWxlLXBpY3R1/cmUtYXZhdGFyLXBo/b3RvLXBsYWNlaG9s/ZGVyLXZlY3Rvci1p/bGx1c3RyYXRpb24u/anBnP3M9NjEyeDYx/MiZ3PTAmaz0yMCZj/PXZmdE1kTGhsZER4/OWhvdU40Vi1nM0M5/azB4bDZZZUJjb0Jf/Ums2VHJjZTA9" alt="product">
										</a>
										<a href="javascript:void(0);">Walk In customer</a>
									</div>
								</td>
								{%endif%}
								<td>{{order.reference}}</td>
								<td>{{order.date}}</td>
								<td><span class="badge badge-success">{{order.status}}</span></td>
								<td>ksh {{order.grand_total | intcomma}}</td>
								<td>ksh {{order.paid_amount | intcomma}}</td>
								<td>ksh {{order.due_amount | intcomma}}</td>
								<td>
									<span class="badge 
									{% if order.payment_status == 'paid' %}badge-soft-success
									{% elif order.payment_status == 'partial' %}badge-soft-warning
									{% elif order.payment_status == 'unpaid' %}badge-soft-danger
									{% else %}badge-soft-info{% endif %} 
									shadow-none badge-xs">
										<i class="ti ti-point-filled me-1" style="color: 
										{% if order.payment_status == 'paid' %}#28a745
										{% elif order.payment_status == 'partial' %}#ffc107
										{% elif order.payment_status == 'unpaid' %}#dc3545
										{% else %}#17a2b8{% endif %}"></i>{{order.payment_status|capfirst}}
									</span>
									{% if order.payment_status == 'partial' %}
									<button class="btn btn-sm btn-outline-primary ms-1 update-payment-btn" 
											data-order-id="{{ order.pk }}" data-due-amount="{{ order.due_amount }}">
										Update Payment
									</button>
									{% endif %}
								</td>
								<td>
									<span class="badge 
									{% if order.payment_method == 'mpesa' %}badge-soft-primary
									{% elif order.payment_method == 'cash' %}badge-soft-success
									{% else %}badge-soft-secondary{% endif %} 
									shadow-none badge-xs">
										{% if order.payment_method == 'mpesa' %}
											<i class="ti ti-device-mobile me-1"></i>M-Pesa
										{% elif order.payment_method == 'cash' %}
											<i class="ti ti-cash me-1"></i>Cash
										{% else %}
											<i class="ti ti-credit-card me-1"></i>{{ order.payment_method|capfirst }}
										{% endif %}
									</span>
								</td>
								<td>{{order.biller}}</td>
								<td class="text-center">
									<a class="action-set" href="javascript:void(0);" data-bs-toggle="dropdown"
										aria-expanded="true">
										<i class="fa fa-ellipsis-v" aria-hidden="true"></i>
									</a>
									<ul class="dropdown-menu">
										<li>
											<a href="#" class="dropdown-item" data-bs-toggle="modal"
												data-bs-target="#sales-details-new" data-order-id="{{ order.pk }}">
												<i data-feather="eye" class="info-img"></i> Sale Detail
											</a>
										</li>
										<!-- <li>
											<a href="javascript:void(0);" class="dropdown-item" data-bs-toggle="modal"
												data-bs-target="#edit-sales-new"><i data-feather="edit"
													class="info-img"></i>Edit Sale</a>
										</li> -->
										<!-- <li>
											<a href="javascript:void(0);" class="dropdown-item" data-bs-toggle="modal"
												data-bs-target="#showpayment"><i data-feather="dollar-sign"
													class="info-img"></i>Show Payments</a>
										</li> -->
										<!-- <li>
											<a href="javascript:void(0);" class="dropdown-item" data-bs-toggle="modal"
												data-bs-target="#createpayment"><i data-feather="plus-circle"
													class="info-img"></i>Create Payment</a>
										</li>
										<li>
											<a href="javascript:void(0);" class="dropdown-item"><i
													data-feather="download" class="info-img"></i>Download pdf</a>
										</li>
										<li>
											<a href="javascript:void(0);" class="dropdown-item mb-0"
												data-bs-toggle="modal" data-bs-target="#delete"><i
													data-feather="trash-2" class="info-img"></i>Delete Sale</a>
										</li> -->
									</ul>
								</td>
							</tr>
							{%endfor%}

						</tbody>
					</table>
				</div>
			</div>
		</div>
		<!-- /product list -->
	</div>
	<div class="footer d-sm-flex align-items-center justify-content-between border-top bg-white p-3">
		<p class="mb-0 text-gray-9">22025 &copy; Twoven Ecommerce. All Right Reserved</p>
		<p>Designed &amp; Developed by <a href="javascript:void(0);" class="text-primary">Twoven</a></p>
	</div>
</div>
<div class="modal fade" id="sales-details-new" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog sales-details-modal">
    <div class="modal-content">

      <!-- Header -->
      <div class="page-header p-4 border-bottom mb-0 d-flex justify-content-between align-items-center">
        <h4 class="mb-0">Sales Detail</h4>
        <div>
          <a data-bs-toggle="tooltip" data-bs-placement="top" title="Export PDF">
            <img src="{%static 'landing/assets/img/icons/pdf.svg'%}" alt="pdf">
          </a>
          <a data-bs-toggle="tooltip" data-bs-placement="top" title="Print">
            <img src="{%static 'landing/assets/img/icons/printer.svg'%}" alt="print">
          </a>
          <!-- <a href="" class="btn btn-secondary ms-3">
            <i data-feather="arrow-left" class="me-1"></i> Back to Sales
          </a> -->
        </div>
      </div>

      <!-- Body/Form -->
      <form>
        <div class="card border-0">
          <div class="card-body pb-0">

            <div class="invoice-box" style="font-size:14px;line-height:24px;color:#555;">
              <div class="row">

                <!-- Customer Info -->
                <div class="col-md-4 mb-4">
                  <h6>Customer Info</h6>
                  <div class="d-flex align-items-center mb-2">
                    <img id="modal-customer-image" class="avatar avatar-md me-2" src="" alt="Customer">
                    <h5 id="modal-customer-name" class="mb-0"></h5>
                  </div>
                  <p id="modal-customer-address" class="mb-1"></p>
                  <p class="mb-1">Email: <span id="modal-customer-email"></span></p>
                  <p class="mb-0">Phone: <span id="modal-customer-phone"></span></p>
                </div>

                <!-- Invoice Info -->
                <div class="col-md-4 mb-4">
                  <h6>Invoice Info</h6>
                  <p class="mb-1">Reference: <strong id="modal-invoice-ref"></strong></p>
                  <p class="mb-1">Date: <span id="modal-invoice-date"></span></p>
                  <p class="mb-1">Status: <span class="badge badge-success" id="modal-invoice-status"></span></p>
                  <p class="mb-1">
                    Payment Status:
                    <span class="badge badge-soft-success" id="modal-invoice-payment-status"></span>
                  </p>
                  <p class="mb-0">Biller: <span id="modal-invoice-biller"></span></p>
                </div>

              </div>

              <!-- Order Summary Table -->
              <h5 class="mt-4">Order Summary</h5>
              <div class="table-responsive mb-3">
                <table class="table" id="modal-items-table">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Price</th>
                      <th>Discount</th>
                      <th>Tax (%)</th>
                      <th>Tax Amount</th>
                      <th>Unit Cost</th>
                      <th>Quantity</th>
                      <th>Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- JS will inject rows here -->
                  </tbody>
                </table>
              </div>

              <!-- Totals -->
              <div class="row">
                <div class="col-lg-6 ms-auto">
                  <ul class="list-unstyled">
                    <li class="d-flex justify-content-between">
                      <span>Order Tax</span><strong id="modal-total-tax"></strong>
                    </li>
                    <li class="d-flex justify-content-between">
                      <span>Discount</span><strong id="modal-total-discount"></strong>
                    </li>
                    <li class="d-flex justify-content-between">
                      <span>Grand Total</span><strong id="modal-grand-total"></strong>
                    </li>
                    <li class="d-flex justify-content-between">
                      <span>Paid</span><strong id="modal-paid"></strong>
                    </li>
                    <li class="d-flex justify-content-between">
                      <span>Due</span><strong id="modal-due"></strong>
                    </li>
                  </ul>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <br>
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>

    </div>
  </div>
</div>


<script>
  document
    .getElementById('sales-details-new')
    .addEventListener('show.bs.modal', async function(event) {
      const btn     = event.relatedTarget;
      const orderId = btn.dataset.orderId;
      if (!orderId) return;

      try {
        const resp = await fetch(`/dashboard/sales/orders/${orderId}/json/`);
        if (!resp.ok) throw new Error('Network response was not OK');
        const data = await resp.json();

        // Customer
        document.getElementById('modal-customer-name').textContent    = data.customer.name;
        document.getElementById('modal-customer-image').src          = data.customer.image;
        document.getElementById('modal-customer-address').textContent = data.customer.address;
        document.getElementById('modal-customer-email').textContent   = data.customer.email;
        document.getElementById('modal-customer-phone').textContent   = data.customer.phone;

        // Invoice
        document.getElementById('modal-invoice-ref').textContent            = data.invoice.reference;
        document.getElementById('modal-invoice-date').textContent           = data.invoice.date;
        document.getElementById('modal-invoice-status').textContent         = data.invoice.status;
        document.getElementById('modal-invoice-payment-status').textContent = data.invoice.payment_status;
        document.getElementById('modal-invoice-biller').textContent         = data.invoice.biller;

        // Items table
        const tbody = document.querySelector('#modal-items-table tbody');
        tbody.innerHTML = '';
        data.items.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.product_name}</td>
            <td>ksh ${item.purchase_price}</td>
            <td>ksh ${item.discount}</td>
            <td>${item.tax}</td>
            <td>ksh ${item.tax_amount}</td>
            <td>ksh ${item.unit_cost}</td>
            <td>${item.quantity}</td>
            <td>ksh ${item.total_cost}</td>
          `;
          tbody.appendChild(tr);
        });

        // Totals
        document.getElementById('modal-total-tax').textContent      = data.totals.order_tax;
        document.getElementById('modal-total-discount').textContent = data.totals.discount;
        document.getElementById('modal-grand-total').textContent    = data.totals.grand_total;
        document.getElementById('modal-paid').textContent           = data.totals.paid;
        document.getElementById('modal-due').textContent            = data.totals.due;
      } catch (err) {
        console.error('Failed to load order details:', err);
      }
  });
</script>

<!-- Update Payment Modal -->
<div class="modal fade" id="update-payment-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Update Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="update-payment-form">
        <div class="modal-body">
          <div class="alert alert-danger d-none" id="payment-error"></div>
          <div class="mb-3">
            <label for="due-amount-display" class="form-label">Due Amount</label>
            <input type="text" class="form-control" id="due-amount-display" readonly>
          </div>
          <div class="mb-3">
            <label for="payment-amount" class="form-label">Payment Amount <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text">KES</span>
              <input type="number" class="form-control" id="payment-amount" step="0.01" min="0.01" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="payment-type" class="form-label">Payment Type</label>
            <select class="form-select" id="payment-type">
              <option value="cash">Cash</option>
              <option value="mpesa">M-PESA</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Payment</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Update Payment functionality
document.addEventListener('DOMContentLoaded', function() {
  const updatePaymentModal = new bootstrap.Modal(document.getElementById('update-payment-modal'));
  const updatePaymentForm = document.getElementById('update-payment-form');
  const paymentError = document.getElementById('payment-error');
  let currentOrderId = null;

  // Handle Update Payment button clicks
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('update-payment-btn')) {
      currentOrderId = e.target.dataset.orderId;
      const dueAmount = e.target.dataset.dueAmount;
      
      // Set the due amount in the modal
      document.getElementById('due-amount-display').value = `KES ${parseFloat(dueAmount).toFixed(2)}`;
      document.getElementById('payment-amount').max = dueAmount;
      
      // Clear previous errors and form
      paymentError.classList.add('d-none');
      updatePaymentForm.reset();
      
      updatePaymentModal.show();
    }
  });

  // Handle form submission
  updatePaymentForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!currentOrderId) return;

    const formData = {
      amount: document.getElementById('payment-amount').value,
      payment_type: document.getElementById('payment-type').value
    };

    try {
      const response = await fetch(`/dashboard/sales/orders/${currentOrderId}/update-payment/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
      });

      const data = await response.json();

      if (data.success) {
        // Update the row in the table
        updateOrderRow(currentOrderId, data.order);
        updatePaymentModal.hide();
        
        // Show success message
        showNotification('Payment updated successfully!', 'success');
      } else {
        // Show error
        paymentError.textContent = data.error;
        paymentError.classList.remove('d-none');
      }
    } catch (error) {
      paymentError.textContent = 'An error occurred while updating payment.';
      paymentError.classList.remove('d-none');
    }
  });

  function updateOrderRow(orderId, orderData) {
    // Find the row and update payment status and amounts
    const rows = document.querySelectorAll('tbody.sales-list tr');
    rows.forEach(row => {
      const updateBtn = row.querySelector(`[data-order-id="${orderId}"]`);
      if (updateBtn) {
        // Update paid amount
        const paidCell = row.cells[6]; // Paid column
        paidCell.textContent = `ksh ${parseFloat(orderData.paid_amount).toLocaleString()}`;
        
        // Update due amount
        const dueCell = row.cells[7]; // Due column
        dueCell.textContent = `ksh ${parseFloat(orderData.due_amount).toLocaleString()}`;
        
        // Update payment status
        const statusCell = row.cells[8]; // Payment Status column
        const badge = statusCell.querySelector('.badge');
        const icon = statusCell.querySelector('.ti-point-filled');
        
        // Update badge classes and text
        badge.className = 'badge shadow-none badge-xs';
        if (orderData.payment_status === 'paid') {
          badge.classList.add('badge-soft-success');
          icon.style.color = '#28a745';
          
          // Remove Update Payment button if fully paid
          const updateBtn = statusCell.querySelector('.update-payment-btn');
          if (updateBtn) {
            updateBtn.remove();
          }
        } else if (orderData.payment_status === 'partial') {
          badge.classList.add('badge-soft-warning');
          icon.style.color = '#ffc107';
          
          // Update button's due amount data
          updateBtn.dataset.dueAmount = orderData.due_amount;
        } else {
          badge.classList.add('badge-soft-danger');
          icon.style.color = '#dc3545';
        }
        
        badge.querySelector('.ti-point-filled').nextSibling.textContent = orderData.payment_status_display;
      }
    });
  }

  function showNotification(message, type = 'info') {
    // Create a simple notification
    const alert = document.createElement('div');
    alert.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alert.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    document.body.appendChild(alert);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
      if (alert.parentNode) {
        alert.parentNode.removeChild(alert);
      }
    }, 5000);
  }
 });
</script>

<!-- POS Orders Filters Enhancement Styles -->
<style>
.filter-group {
    position: relative;
}

.filter-group .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.filter-group .form-select.filter-active {
    border-color: #0d6efd !important;
    background-color: #f8f9fa !important;
}

.filter-actions .btn {
    white-space: nowrap;
}

.visually-hidden {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0, 0, 0, 0) !important;
    white-space: nowrap !important;
    border: 0 !important;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.animate-spin {
    animation: spin 1s linear infinite;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .filter-group {
        margin-bottom: 0.5rem;
    }
    
    .filter-group .form-select {
        width: 100% !important;
        min-width: 150px;
    }
    
    .filter-actions {
        width: 100%;
        justify-content: space-between;
    }
}
</style>

<!-- POS Orders Filters Enhancement -->
<script src="{% static 'js/pos/pos-orders-filters.js' %}"></script>

{%endblock%}