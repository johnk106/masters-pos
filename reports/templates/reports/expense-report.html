{%extends 'landing/base.html'%}
{%load static%}
{%load humanize%}

{%block head%}

<title>Expense report</title>
{%endblock%}


{%block body%}
<div class="page-wrapper">
				<div class="content">
					<div class="page-header">
						<div class="add-item d-flex">
							<div class="page-title">
								<h4>Expense Report</h4>
								<h6>View Reports of Expenses</h6>
							</div>
						</div>
						<ul class="table-top-head">
							<li class="me-2">
								<a data-bs-toggle="tooltip" data-bs-placement="top" title="Refresh"><i class="ti ti-refresh"></i></a>
							</li>
							<li>
								<a data-bs-toggle="tooltip" data-bs-placement="top" title="Collapse" id="collapse-header"><i class="ti ti-chevron-up"></i></a>
							</li>
						</ul>
					</div>
					<div class="card">
						<div class="card-body pb-1">
							<form action="">
								<!-- Error Message -->
								{% if error_message %}
								<div class="alert alert-danger alert-dismissible fade show" role="alert">
									{{ error_message }}
									<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
								</div>
								{% endif %}
								
								<div class="row align-items-end">
									<div class="col-lg-10">
										<div class="row">
											<div class="col-md-3">
												<div class="mb-3">
													<label class="form-label">Choose Date Range</label>
													<div class="d-flex align-items-center">
														<div class="input-groupicon calender-input me-2">
															<i data-feather="calendar" class="info-img"></i>
															<input type="text" id="start-date" class="datetimepicker form-control" 
																   placeholder="Start Date" style="min-width: 120px;">
														</div>
														<span class="me-2">to</span>
														<div class="input-groupicon calender-input">
															<i data-feather="calendar" class="info-img"></i>
															<input type="text" id="end-date" class="datetimepicker form-control" 
																   placeholder="End Date" style="min-width: 120px;">
														</div>
													</div>
													<input type="hidden" name="date_range" id="date-range-hidden" value="{{ date_range }}">
												</div>
											</div>
											<div class="col-md-3">
												<div class="mb-3">
													<label class="form-label">Expense Category</label>
													<select class="select">
														<option>All</option>
														<option>Electricity Payment</option>
														<option>Stationery Purchase</option>
														<option>AC Repair Service</option>
													</select>
												</div>
											</div>
											<div class="col-md-3">
												<div class="mb-3">
													<label class="form-label">Payment Method</label>
													<select class="select">
														<option>All</option>
														<option>Paypal</option>
														<option>Cash</option>
														<option>Credit Card</option>
													</select>
												</div>
											</div>
											<div class="col-md-3">
												<div class="mb-3">
													<label class="form-label">Status</label>
													<select class="select">
														<option>All</option>
														<option>Approved</option>
														<option>Pending</option>
													</select>
												</div>
											</div>
										</div>
									</div>
									<div class="col-lg-2">
										<div class="mb-3">
											<button class="btn btn-primary w-100" type="submit">Generate Report</button>
										</div>
									</div>
								</div>
							</form>
						</div>
					</div>
					<!-- /product list -->
					<div class="card no-search">
						<div class="card-header d-flex align-items-center justify-content-between flex-wrap row-gap-3">
							<div>
								<h4>Expense Report</h4>
							</div>
							<ul class="table-top-head">
							<li>
					<a data-bs-toggle="tooltip" data-bs-placement="top" title="Pdf" href="{{ export_pdf_url }}"><img
							src="{%static 'landing/assets/img/icons/pdf.svg'%}" alt="img"></a>
				</li>
				<li>
					<a data-bs-toggle="tooltip" data-bs-placement="top" title="Excel" href="{{ export_excel_url }}"><img
							src="{%static 'landing/assets/img/icons/excel.svg'%}" alt="img"></a>
				</li>	
								<li>
									<a data-bs-toggle="tooltip" data-bs-placement="top" title="Print"><i class="ti ti-printer"></i></a>
								</li>
							</ul>
						</div>
						<div class="card-body p-0">
							<div class="table-responsive">
								<table class="table datatable">
									<thead class="thead-light">
										<tr>
											<th>Expense Name</th>
											<th>Category</th>
											<th>Description</th>
											<th>Date</th>
											<th>Amount</th>
											<th>Status</th>
										</tr>
									</thead>
									<tbody>
										{%for expense in page_obj%}
										<tr>
											<td>{{expense.name}}</td>
											<td>{{expense.category.name}}</td>
											<td>{{expense.description}}</td>
											<td>{{expense.date}}</td>
											<td>ksh {{expense.amount | intcomma}}</td>
											<td>
												<span class="badge badge-cyan d-inline-flex align-items-center badge-xs">
													{{expense.status}}
												</span>
											</td>
										</tr>
										{%endfor%}
										
									</tbody>
								</table>
							</div>
						</div>
					</div>
					<!-- /product list -->
				</div>
				<div class="footer d-sm-flex align-items-center justify-content-between border-top bg-white p-3">
					<p class="mb-0">2025 &copy; TwovenPOS. All Right Reserved</p>
					<p>Designed &amp; Developed by <a href="javascript:void(0);" class="text-primary">Twoven</a></p>
				</div>
			</div>

<style>
.calender-input {
  position: relative;
}
.calender-input .info-img {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: #6c757d;
  pointer-events: none;
  z-index: 5;
}
.calender-input .form-control {
  padding-right: 35px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Date range form handling for expense report
  const startDateInput = document.getElementById('start-date');
  const endDateInput = document.getElementById('end-date');
  const hiddenDateRange = document.getElementById('date-range-hidden');
  
  if (startDateInput && endDateInput && hiddenDateRange) {
    
    // Parse existing date range value and populate individual fields
    const existingDateRange = hiddenDateRange.value.trim();
    if (existingDateRange) {
      try {
        const parts = existingDateRange.split(' - ');
        if (parts.length === 2) {
          startDateInput.value = parts[0].trim();
          endDateInput.value = parts[1].trim();
        }
      } catch (error) {
        console.log('Error parsing existing date range:', error);
      }
    }
    
    // Function to combine dates into range format
    function updateDateRange() {
      const startDate = startDateInput.value.trim();
      const endDate = endDateInput.value.trim();
      
      if (startDate && endDate) {
        hiddenDateRange.value = startDate + ' - ' + endDate;
      } else {
        hiddenDateRange.value = '';
      }
    }
    
    // Update hidden field when either date changes
    startDateInput.addEventListener('dp.change', updateDateRange);
    endDateInput.addEventListener('dp.change', updateDateRange);
    startDateInput.addEventListener('change', updateDateRange);
    endDateInput.addEventListener('change', updateDateRange);
    
    // Form validation on submit
    const form = startDateInput.closest('form');
    if (form) {
      form.addEventListener('submit', function(e) {
        const startDate = startDateInput.value.trim();
        const endDate = endDateInput.value.trim();
        
        // Allow submission with no dates (will show full range)
        if (!startDate && !endDate) {
          hiddenDateRange.value = '';
          return true;
        }
        
        // If one date is provided, both must be provided
        if ((startDate && !endDate) || (!startDate && endDate)) {
          e.preventDefault();
          alert('Please select both start and end dates, or leave both empty for full range.');
          return false;
        }
        
        // Update the hidden field before submission
        updateDateRange();
      });
    }
    
    // Initialize date pickers with proper format
    setTimeout(function() {
      if (typeof $.fn.datetimepicker !== 'undefined') {
        $('#start-date, #end-date').datetimepicker({
          format: 'DD/MM/YYYY',
          useCurrent: false,
          showTodayButton: true,
          showClear: true,
          icons: {
            up: "fas fa-angle-up",
            down: "fas fa-angle-down",
            next: 'fas fa-angle-right',
            previous: 'fas fa-angle-left',
            today: 'fas fa-calendar-check',
            clear: 'fas fa-trash'
          }
        });
        
        // Set max date for start date picker based on end date
        $('#start-date').on('dp.change', function(e) {
          $('#end-date').data('DateTimePicker').minDate(e.date);
          updateDateRange();
        });
        
        // Set min date for end date picker based on start date
        $('#end-date').on('dp.change', function(e) {
          $('#start-date').data('DateTimePicker').maxDate(e.date);
          updateDateRange();
        });
      }
    }, 100);
  }
});
</script>

{%endblock%}