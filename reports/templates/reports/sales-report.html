{%extends 'landing/base.html'%}
{%load static%}
{%load humanize%}


{%block head%}

<title>Sales report</title>

{%endblock%}



{%block body%}
<div class="page-wrapper">
				<div class="content">
					<div class="page-header">
						<div class="add-item d-flex">
							<div class="page-title">
								<h4>Sales Report</h4>
								<h6>Manage your Sales report</h6>
							</div>
						</div>
						<ul class="table-top-head">
							<li class="me-2">
								<a data-bs-toggle="tooltip" data-bs-placement="top" title="Refresh"><i class="ti ti-refresh"></i></a>
							</li>
							<li class="me-2">
								<a data-bs-toggle="tooltip" data-bs-placement="top" title="Collapse" id="collapse-header"><i class="ti ti-chevron-up"></i></a>
							</li>
						</ul>
					</div>
					<div class="row">
						<div class="col-xl-3 col-sm-6 col-12 d-flex">
							<div class="card border border-success sale-widget flex-fill">
								<div class="card-body d-flex align-items-center">
									<span class="sale-icon bg-success text-white">
										<i class="ti ti-align-box-bottom-left-filled fs-24"></i>
									</span>
									<div class="ms-2">
										<p class="fw-medium mb-1">Total Amount</p>
										<div>
											<h3>ksh {{total_amount | intcomma}}</h3>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="col-xl-3 col-sm-6 col-12 d-flex">
							<div class="card border border-info sale-widget flex-fill">
								<div class="card-body d-flex align-items-center">
									<span class="sale-icon bg-info text-white">
										<i class="ti ti-align-box-bottom-left-filled fs-24"></i>
									</span>
									<div class="ms-2">
										<p class="fw-medium mb-1">Total Paid</p>
										<div>
											<h3>ksh {{total_paid | intcomma}}</h3>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="col-xl-3 col-sm-6 col-12 d-flex">
							<div class="card border border-orange sale-widget flex-fill">
								<div class="card-body d-flex align-items-center">
									<span class="sale-icon bg-orange text-white">
										<i class="ti ti-moneybag fs-24"></i>
									</span>
									<div class="ms-2">
										<p class="fw-medium mb-1">Total Unpaid</p>
										<div>
											<h3>ksh {{total_unpaid | intcomma}}</h3>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="col-xl-3 col-sm-6 col-12 d-flex">
							<div class="card border border-danger sale-widget flex-fill">
								<div class="card-body d-flex align-items-center">
									<span class="sale-icon bg-danger text-white">
										<i class="ti ti-alert-circle-filled fs-24"></i>
									</span>
									<div class="ms-2">
										<p class="fw-medium mb-1">Overdue</p>
										<div>
											<h3>ksh {{overdue| intcomma}}</h3>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
										<!-- Error message display -->
					{% if error_message %}
						<div class="alert alert-danger" role="alert">
							<i class="fas fa-exclamation-triangle me-2"></i>
							{{ error_message }}
						</div>
					{% endif %}

					<div class="card">
						<div class="card-body pb-1">
							<form method="GET" id="sales-report-form">
								<div class="row align-items-end">
									<div class="col-lg-10">
										<div class="row">
											<div class="col-md-4">
												<div class="mb-3">
													<label class="form-label">Choose Date Range</label>
													<div class="d-flex align-items-center">
														<div class="input-groupicon calender-input me-2">
															<i data-feather="calendar" class="info-img"></i>
															<input type="text" id="start-date" class="datetimepicker form-control" 
																   placeholder="Start Date" style="min-width: 120px;">
														</div>
														<span class="me-2">to</span>
														<div class="input-groupicon calender-input">
															<i data-feather="calendar" class="info-img"></i>
															<input type="text" id="end-date" class="datetimepicker form-control" 
																   placeholder="End Date" style="min-width: 120px;">
														</div>
													</div>
													<input type="hidden" name="date_range" id="date-range-hidden" value="{{ date_range }}">
												</div>
											</div>
											
											<div class="col-md-4">
												<div class="mb-3">
													<label class="form-label">Products</label>
													<select class="select" name="product">
														<option value="All" {% if selected_product == 'All' %}selected{% endif %}>All</option>
														{%for product in products%}
														<option value="{{product}}" {% if selected_product == product %}selected{% endif %}>{{product}}</option>
														{%endfor%}
													</select>
												</div>
											</div>
										</div>
									</div>
									<div class="col-lg-2">
										<div class="mb-3">
											<button class="btn btn-primary w-100" type="submit">Generate Report</button>
										</div>
									</div>
								</div>
							</form>
						</div>
					</div>
					
					<div class="card no-search">
						<div class="card-header d-flex align-items-center justify-content-between flex-wrap row-gap-3">
							<div>
								<h4>Sales Report</h4>
							</div>
							<ul class="table-top-head">
									<li>
					<a data-bs-toggle="tooltip" data-bs-placement="top" title="Pdf" href="{{ export_pdf_url }}">
						<img src="{% static 'landing/assets/img/icons/pdf.svg' %}" alt="PDF">
					</a>
				</li>
				<li>
					<a data-bs-toggle="tooltip" data-bs-placement="top" title="Excel" href="{{ export_excel_url }}">
						<img src="{% static 'landing/assets/img/icons/excel.svg' %}" alt="Excel">
					</a>
				</li>
								<li>
									<a data-bs-toggle="tooltip" data-bs-placement="top" title="Print"><i class="ti ti-printer"></i></a>
								</li>
							</ul>
						</div>
						<div class="card-body p-0">
							<div class="table-responsive">
								<table class="table datatable">
									<thead class="thead-light">
										<tr>
											<th>SKU</th>
											<th>Product Name</th>
											<th>Category</th>
											<th>Sold Qty</th>
											<th>Sold Amount</th>
											<!-- <th>Instock Qty</th> -->
										</tr>
									</thead>
									<tbody>
										{%for row in report_rows%}
									
										<tr>

											
											<td>
												<a >{{row.sku}}</a>
											</td>
											<td>
												<div class="d-flex align-items-center">
													<!-- <a  class="avatar avatar-md"><img src="{{row.product.first_image_url}}" class="img-fluid" alt="img"></a>
													<div class="ms-2"> -->
														<p class="text-dark mb-0"><a>{{row.name}} </a></p>
													</div>
												</div>
											</td>
										
											<td>
												{{row.category}}								
											</td>
											<td>{{row.sold_qty}}</td>
											<td>
												ksh {{row.sold_amount | intcomma}}
											</td>

											
										</tr>

										{%endfor%}
									
									</tbody>
								</table>
							</div>
						</div>
					</div>
					<!-- /product list -->
				</div>
				<div class="footer d-sm-flex align-items-center justify-content-between border-top bg-white p-3">
					<p class="mb-0">2025 &copy; TwovenPOS. All Right Reserved</p>
					<p>Designed &amp; Developed by <a href="javascript:void(0);" class="text-primary">Twoven</a></p>
				</div>
			</div>

<!-- Sales Report Date Picker Styles and Scripts -->
<style>
/* Date picker specific styles */
.calender-input {
  position: relative;
  display: inline-block;
}

.calender-input .info-img {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: #6c757d;
  z-index: 3;
  pointer-events: none;
  width: 16px;
  height: 16px;
}

.calender-input .form-control {
  padding-right: 35px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Date range form handling for sales report
  const salesReportForm = document.getElementById('sales-report-form');
  const startDateInput = document.getElementById('start-date');
  const endDateInput = document.getElementById('end-date');
  const hiddenDateRange = document.getElementById('date-range-hidden');
  
  if (salesReportForm && startDateInput && endDateInput && hiddenDateRange) {
    
    // Parse existing date range value and populate individual fields
    const existingDateRange = hiddenDateRange.value.trim();
    if (existingDateRange) {
      try {
        const parts = existingDateRange.split(' - ');
        if (parts.length === 2) {
          startDateInput.value = parts[0].trim();
          endDateInput.value = parts[1].trim();
        }
      } catch (error) {
        console.log('Error parsing existing date range:', error);
      }
    }
    
    // Function to combine dates into range format
    function updateDateRange() {
      const startDate = startDateInput.value.trim();
      const endDate = endDateInput.value.trim();
      
      if (startDate && endDate) {
        hiddenDateRange.value = startDate + ' - ' + endDate;
      } else {
        hiddenDateRange.value = '';
      }
    }
    
    // Update hidden field when either date changes
    startDateInput.addEventListener('dp.change', updateDateRange);
    endDateInput.addEventListener('dp.change', updateDateRange);
    startDateInput.addEventListener('change', updateDateRange);
    endDateInput.addEventListener('change', updateDateRange);
    
    // Form validation on submit
    salesReportForm.addEventListener('submit', function(e) {
      const startDate = startDateInput.value.trim();
      const endDate = endDateInput.value.trim();
      
      // Allow submission with no dates (will show full range)
      if (!startDate && !endDate) {
        hiddenDateRange.value = '';
        return true;
      }
      
      // If one date is provided, both must be provided
      if ((startDate && !endDate) || (!startDate && endDate)) {
        e.preventDefault();
        alert('Please select both start and end dates, or leave both empty for full range.');
        return false;
      }
      
      // Update the hidden field before submission
      updateDateRange();
    });
    
    // Initialize date pickers with proper format
    setTimeout(function() {
      if (typeof $.fn.datetimepicker !== 'undefined') {
        $('#start-date, #end-date').datetimepicker({
          format: 'DD/MM/YYYY',
          useCurrent: false,
          showTodayButton: true,
          showClear: true,
          icons: {
            up: "fas fa-angle-up",
            down: "fas fa-angle-down",
            next: 'fas fa-angle-right',
            previous: 'fas fa-angle-left',
            today: 'fas fa-calendar-check',
            clear: 'fas fa-trash'
          }
        });
        
        // Set max date for start date picker based on end date
        $('#start-date').on('dp.change', function(e) {
          $('#end-date').data('DateTimePicker').minDate(e.date);
          updateDateRange();
        });
        
        // Set min date for end date picker based on start date
        $('#end-date').on('dp.change', function(e) {
          $('#start-date').data('DateTimePicker').maxDate(e.date);
          updateDateRange();
        });
      }
    }, 100);
  }
});
</script>

{%endblock%}