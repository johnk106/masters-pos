{%extends 'landing/base.html'%}
{%load static%}
{%load humanize%}


{%block head%}

<title>Best sellers</title>

{%endblock%}



{%block body%}

<div class="page-wrapper">
				<div class="content">
					<div class="page-header">
						<div class="add-item d-flex">
							<div class="page-title">
								<h4>Bestseller Products Report</h4>
								<h6>View Reports of Best Selling Products</h6>
							</div>
						</div>
						<ul class="table-top-head">
							<li class="me-2">
								<a data-bs-toggle="tooltip" data-bs-placement="top" title="Refresh"><i class="ti ti-refresh"></i></a>
							</li>
							<li class="me-2">
								<a data-bs-toggle="tooltip" data-bs-placement="top" title="Collapse" id="collapse-header"><i class="ti ti-chevron-up"></i></a>
							</li>
						</ul>
										</div>
					
					<!-- Error message display -->
					{% if error_message %}
						<div class="alert alert-danger" role="alert">
							<i class="fas fa-exclamation-triangle me-2"></i>
							{{ error_message }}
						</div>
					{% endif %}

					<div class="card">
						<div class="card-body pb-1">
							<form method="GET" id="best-sellers-form">
								<div class="row align-items-end">
									<div class="col-md-6">
										<div class="mb-3">
											<label class="form-label">Choose Date Range</label>
											<div class="d-flex align-items-center">
												<div class="input-groupicon calender-input me-2">
													<i data-feather="calendar" class="info-img"></i>
													<input type="text" id="start-date" class="datetimepicker form-control" 
														   placeholder="Start Date" style="min-width: 120px;">
												</div>
												<span class="me-2">to</span>
												<div class="input-groupicon calender-input">
													<i data-feather="calendar" class="info-img"></i>
													<input type="text" id="end-date" class="datetimepicker form-control" 
														   placeholder="End Date" style="min-width: 120px;">
												</div>
											</div>
											<input type="hidden" name="date_range" id="date-range-hidden" value="{{ date_range }}">
										</div>
									</div>
									<div class="col-lg-3">
										<div class="mb-3">
											<button class="btn btn-primary" type="submit">Generate Report</button>
										</div>
									</div>
								</div>
							</form>
						</div>
					</div>
					<!-- /product list -->
					<div class="card no-search">
						<div class="card-header d-flex align-items-center justify-content-between flex-wrap row-gap-3">
							<div>
								<h4>Best Sellers</h4>
							</div>
							<ul class="table-top-head">
									<li>
					<a data-bs-toggle="tooltip" data-bs-placement="top" title="Pdf" href="{{ export_pdf_url }}">
						<img src="{% static 'landing/assets/img/icons/pdf.svg' %}" alt="PDF">
					</a>
				</li>
				<li>
					<a data-bs-toggle="tooltip" data-bs-placement="top" title="Excel" href="{{ export_excel_url }}">
						<img src="{% static 'landing/assets/img/icons/excel.svg' %}" alt="Excel">
					</a>
				</li>
								<li>
									<a data-bs-toggle="tooltip" data-bs-placement="top" title="Print"><i class="ti ti-printer"></i></a>
								</li>
							</ul>
						</div>
						<div class="card-body p-0">
							<div class="table-responsive">
								<table class="table datatable">
									<thead class="thead-light">
										<tr>
											<th>SKU</th>
											<th>Product Name</th>
											<th>Category</th>
											<th>Sold Qty</th>
											<th>Sold Amount</th>
											<th>Instock Qty</th>
										</tr>
									</thead>
									<tbody>
										{%for product in page_obj%}
										<tr>
											
											<td>
												<a>{{product.sku}}</a>
											</td>
											<td>
												<div class="d-flex align-items-center">
													<a  class="avatar avatar-md"><img src="{{product.first_image_url}}" class="img-fluid" alt="img"></a>
													<div class="ms-2">
														<p class="text-dark mb-0"><a>{{product.name}}</a></p>
													</div>
												</div>
											</td>
										
											<td>
												{{product.category.name}}									
											</td>
											<td>{{product.sold_qty}}</td>
											<td>
												ksh {{product.sold_amount | intcomma}}
											</td>
											<td>
												{{product.stock.quantity}}
											</td>
											
										</tr>
									
										{%endfor%}
										
									</tbody>
								</table>
							</div>
						</div>
					</div>
					<!-- /product list -->
				</div>
				<div class="footer d-sm-flex align-items-center justify-content-between border-top bg-white p-3">
					<p class="mb-0">2025 &copy; TwovenPOS. All Right Reserved</p>
					<p>Designed &amp; Developed by <a href="javascript:void(0);" class="text-primary">Twoven</a></p>
				</div>
			</div>

<!-- Best Sellers Report Date Picker Styles and Scripts -->
<style>
/* Date picker specific styles */
.calender-input {
  position: relative;
  display: inline-block;
}

.calender-input .info-img {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: #6c757d;
  z-index: 3;
  pointer-events: none;
  width: 16px;
  height: 16px;
}

.calender-input .form-control {
  padding-right: 35px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Date range form handling for best sellers report
  const bestSellersForm = document.getElementById('best-sellers-form');
  const startDateInput = document.getElementById('start-date');
  const endDateInput = document.getElementById('end-date');
  const hiddenDateRange = document.getElementById('date-range-hidden');
  
  if (bestSellersForm && startDateInput && endDateInput && hiddenDateRange) {
    
    // Parse existing date range value and populate individual fields
    const existingDateRange = hiddenDateRange.value.trim();
    if (existingDateRange) {
      try {
        const parts = existingDateRange.split(' - ');
        if (parts.length === 2) {
          startDateInput.value = parts[0].trim();
          endDateInput.value = parts[1].trim();
        }
      } catch (error) {
        console.log('Error parsing existing date range:', error);
      }
    }
    
    // Function to combine dates into range format
    function updateDateRange() {
      const startDate = startDateInput.value.trim();
      const endDate = endDateInput.value.trim();
      
      if (startDate && endDate) {
        hiddenDateRange.value = startDate + ' - ' + endDate;
      } else {
        hiddenDateRange.value = '';
      }
    }
    
    // Update hidden field when either date changes
    startDateInput.addEventListener('dp.change', updateDateRange);
    endDateInput.addEventListener('dp.change', updateDateRange);
    startDateInput.addEventListener('change', updateDateRange);
    endDateInput.addEventListener('change', updateDateRange);
    
    // Form validation on submit
    bestSellersForm.addEventListener('submit', function(e) {
      const startDate = startDateInput.value.trim();
      const endDate = endDateInput.value.trim();
      
      // Allow submission with no dates (will show full range)
      if (!startDate && !endDate) {
        hiddenDateRange.value = '';
        return true;
      }
      
      // If one date is provided, both must be provided
      if ((startDate && !endDate) || (!startDate && endDate)) {
        e.preventDefault();
        alert('Please select both start and end dates, or leave both empty for full range.');
        return false;
      }
      
      // Update the hidden field before submission
      updateDateRange();
    });
    
    // Initialize date pickers with proper format
    setTimeout(function() {
      if (typeof $.fn.datetimepicker !== 'undefined') {
        $('#start-date, #end-date').datetimepicker({
          format: 'DD/MM/YYYY',
          useCurrent: false,
          showTodayButton: true,
          showClear: true,
          icons: {
            up: "fas fa-angle-up",
            down: "fas fa-angle-down",
            next: 'fas fa-angle-right',
            previous: 'fas fa-angle-left',
            today: 'fas fa-calendar-check',
            clear: 'fas fa-trash'
          }
        });
        
        // Set max date for start date picker based on end date
        $('#start-date').on('dp.change', function(e) {
          $('#end-date').data('DateTimePicker').minDate(e.date);
          updateDateRange();
        });
        
        // Set min date for end date picker based on start date
        $('#end-date').on('dp.change', function(e) {
          $('#start-date').data('DateTimePicker').maxDate(e.date);
          updateDateRange();
        });
      }
    }, 100);
  }
});
</script>

{%endblock%}