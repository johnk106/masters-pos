{%extends 'landing/base.html'%}
{%load static%}


{%block head%}

<title>Sub-categories</title>

{%endblock%}


{%block body%}

<div class="page-wrapper">
	<div class="content">
		<div class="page-header">
			<div class="add-item d-flex">
				<div class="page-title">
					<h4 class="fw-bold">Sub Category</h4>
					<h6>Manage your sub categories</h6>

					{% if messages %}
					{% for message in messages %}
					{% if message.tags == 'error' %}
					<!-- Error Alert -->
					<div class="alert alert-solid-danger alert-dismissible fade show">
						{{message}}
						<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"><i
								class="fas fa-xmark"></i></button>
					</div>
					{% elif message.tags == 'success' %}
					<!-- Success Alert -->
					<div class="alert alert-solid-success alert-dismissible fade show">
						{{message}}
						<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"><i
								class="fas fa-xmark"></i></button>
					</div>
					{% endif %}
					{% endfor %}
					{% endif %}
				</div>
			</div>
			<ul class="table-top-head">
				<li>
					<a data-bs-toggle="tooltip" data-bs-placement="top" title="Pdf" href="{{ export_pdf_url }}"><img
							src="{%static 'landing/assets/img/icons/pdf.svg'%}" alt="img"></a>
				</li>
				<li>
					<a data-bs-toggle="tooltip" data-bs-placement="top" title="Excel" href="{{ export_excel_url }}"><img
							src="{%static 'landing/assets/img/icons/excel.svg'%}" alt="img"></a>
				</li>
				<li>
					<a data-bs-toggle="tooltip" data-bs-placement="top" title="Refresh"><i
							class="ti ti-refresh"></i></a>
				</li>
				<li>
					<a data-bs-toggle="tooltip" data-bs-placement="top" title="Collapse" id="collapse-header"><i
							class="ti ti-chevron-up"></i></a>
				</li>
			</ul>
			<div class="page-btn">
				<a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add-category"><i
						class="ti ti-circle-plus me-1"></i>Add Sub Category</a>
			</div>
		</div>


		<!-- /product list -->
		<div class="card">
			<div class="card-header d-flex align-items-center justify-content-between flex-wrap row-gap-3">
				<div class="search-set">
					<div class="search-input">
						<span class="btn-searchset"><i class="ti ti-search fs-14 feather-search"></i></span>
					</div>
				</div>
				<div class="d-flex table-dropdown my-xl-auto right-content align-items-center flex-wrap row-gap-3">
					<div class="dropdown me-2">
						<a href="javascript:void(0);"
							class="dropdown-toggle btn btn-white btn-md d-inline-flex align-items-center"
							data-bs-toggle="dropdown">
							Category
						</a>
						<ul class="dropdown-menu  dropdown-menu-end p-3">
							<li>
								<a href="javascript:void(0);" class="dropdown-item rounded-1">Computers</a>
							</li>
							<li>
								<a href="javascript:void(0);" class="dropdown-item rounded-1">Electronics</a>
							</li>
							<li>
								<a href="javascript:void(0);" class="dropdown-item rounded-1">Shoe</a>
							</li>
							<li>
								<a href="javascript:void(0);" class="dropdown-item rounded-1">Electronics</a>
							</li>
						</ul>
					</div>
					<div class="dropdown">
						<a href="javascript:void(0);"
							class="dropdown-toggle btn btn-white btn-md d-inline-flex align-items-center"
							data-bs-toggle="dropdown">
							Status
						</a>
						<ul class="dropdown-menu  dropdown-menu-end p-3">
							<li>
								<a href="javascript:void(0);" class="dropdown-item rounded-1">Active</a>
							</li>
							<li>
								<a href="javascript:void(0);" class="dropdown-item rounded-1">Inactive</a>
							</li>
						</ul>
					</div>
				</div>
			</div>
			<div class="card-body p-0">
				<div class="table-responsive">
					<table class="table">
						<thead class="thead-light">
							<tr>
								<th class="no-sort">
									<label class="checkboxs">
										<input type="checkbox" id="select-all">
										<span class="checkmarks"></span>
									</label>
								</th>
								<th>Image</th>
								<th>Sub Category</th>
								<th>Category</th>
								<th>slug</th>
								<th>Description</th>
								<th>Status</th>
								<th class="no-sort"></th>
							</tr>
						</thead>
						<tbody>

							{% for category in page_obj %}
							<tr>
								<td>
									<label class="checkboxs">
										<input type="checkbox">
										<span class="checkmarks"></span>
									</label>
								</td>

								<!-- Thumbnail image for this subcategory -->
								<td>
									<a class="avatar avatar-md me-2">
										<img src="{{ category.image.url }}" alt="subcategory image">
									</a>
								</td>

								<td>{{ category.name }}</td>
								<td>{{ category.category.name }}</td> {# parent category’s name #}
								<td>{{ category.slug }}</td>
								<td>{{ category.description|truncatechars:20 }}</td>
								{% if category.status %}
								<td><span class="badge bg-success fw-medium fs-10">Active</span></td>
								{% else %}
								<td><span class="badge bg-secondary fw-medium fs-10">Inactive</span></td>
								{% endif %}

								<td class="action-table-data">
									<div class="edit-delete-action">

										<!-- EDIT BUTTON -->
										<a href="#" class="me-2 p-2 btn-edit-subcategory" data-bs-toggle="modal"
											data-bs-target="#edit-subcategory-modal" data-id="{{ category.id }}"
											data-name="{{ category.name }}" data-slug="{{ category.slug }}"
											data-description="{{ category.description }}"
											data-status="{{ category.status|yesno:'true,false' }}"
											data-image-url="{{ category.image.url }}"
											data-parent-id="{{ category.category.id }}">
											<i data-feather="edit" class="feather-edit"></i>
										</a>

										<!-- DELETE BUTTON -->
										<a href="#" class="p-2 btn-delete-subcategory" data-bs-toggle="modal"
											data-bs-target="#delete-subcategory-modal" data-id="{{ category.id }}"
											data-name="{{ category.name }}">
											<i data-feather="trash-2" class="feather-trash-2"></i>
										</a>

									</div>
								</td>
							</tr>
							{% endfor %}

						</tbody>
					</table>
				</div>
			</div>
		</div>
		<!-- /product list -->
	</div>
	<div class="footer d-sm-flex align-items-center justify-content-between border-top bg-white p-3">
		<p class="mb-0 text-gray-9">22025 &copy; Twoven Ecommerce. All Right Reserved</p>
		<p>Designed &amp; Developed by <a href="javascript:void(0);" class="text-primary">Twoven</a></p>
	</div>
</div>

<!-- Add Category -->
<div class="modal fade" id="add-category">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<div class="page-title">
					<h4>Add Sub Category</h4>
				</div>
				<button type="button" class="close bg-danger text-white fs-16" data-bs-dismiss="modal"
					aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form action="{%url 'inventory:create-subcategory'%}" method="POST" enctype="multipart/form-data">
				{%csrf_token%}
				<div class="modal-body">
					<!-- <div class="mb-3">
								<div class="add-image-upload">
									<div class="add-image">
										<span class="fw-normal"><i data-feather="plus-circle" class="plus-down-add"></i> Add Image</span>
									</div>
									<div class="new-employee-field">
										<div class="mb-0">
											<div class="image-upload mb-2">
												<input type="file">
												<div class="image-uploads">
													<h4 class="fs-13 fw-medium">Upload Image</h4>
												</div>
											</div>
											<span>JPEG, PNG up to 2 MB</span>
										</div>
									</div>
								</div>
							</div> -->
					<div class="mb-3">
						<label for="image" class="form-label">image</label>
						<input type="file" name="image" required>
					</div>
					<div class="mb-3">
						<label class="form-label">Category<span class="text-danger ms-1">*</span></label>
						<select class="select" name="category">
							{%for category in categories%}
							<option value="{{category.id}}">{{category.name}}</option>
							{%endfor%}
						</select>
					</div>
					<div class="mb-3">
						<label class="form-label">Name<span class="text-danger ms-1">*</span></label>
						<input type="text" class="form-control" name="name">
					</div>
					<div class="mb-3">
						<label class="form-label">Slug<span class="text-danger ms-1">*</span></label>
						<input type="text" name="slug" class="form-control">
					</div>
					<div class="mb-3">
						<label class="form-label">Description<span class="text-danger ms-1">*</span></label>
						<textarea class="form-control" name="description"></textarea>
					</div>
					<div class="mb-0">
						<div class="status-toggle modal-status d-flex justify-content-between align-items-center">
							<span class="status-label">Status</span>
							<input type="checkbox" id="user2" class="check" checked="">
							<label for="user2" class="checktoggle"></label>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn me-2 btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary">Add Sub Category</button>
				</div>
			</form>
		</div>
	</div>
</div>
<!-- /Add Category -->

<!-- Edit Category -->
<!-- Edit Subcategory Modal -->
<div class="modal fade" id="edit-subcategory-modal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">

			<div class="modal-header">
				<div class="page-title">
					<h4>Edit Sub Category</h4>
				</div>
				<button type="button" class="btn-close bg-danger text-white" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>

			<!--
        Note: action="" is blank for now. We'll fill it via JS to point to:
        /inventory/subcategories/<id>/edit/
      -->
			<form id="editSubcategoryForm" method="POST" enctype="multipart/form-data" action="">
				{% csrf_token %}
				<div class="modal-body">

					<!-- Hidden field for subcategory ID (optional if you also put it in the URL) -->
					<input type="hidden" name="subcategory_id" id="edit-subcategory-id" />

					<!-- Image preview -->
					<div class="mb-3">
						<div class="add-image-upload">
							<div class="add-image p-1 border-solid text-center" id="edit-image-preview">
								<!-- We will insert an <img> here via JS -->
								<img src="" alt="Image Preview" id="edit-current-image"
									style="max-width: 100px; max-height:100px;" />
								<button type="button" class="btn btn-sm btn-danger image-close" id="edit-image-remove"
									style="position: absolute; top: 0; right: 0;">
									✕
								</button>
							</div>
							<div class="new-employee-field">
								<div class="mb-0">
									<div class="image-upload mb-2">
										<input type="file" name="image" id="edit-image-input" accept="image/*" />
										<div class="image-uploads">
											<h4 class="fs-13 fw-medium">Change Image</h4>
										</div>
									</div>
									<span class="fs-12">JPEG or PNG, up to 2 MB</span>
								</div>
							</div>
						</div>
					</div>

					<!-- Parent Category dropdown -->
					<div class="mb-3">
						<label for="edit-parent-category" class="form-label">
							Parent Category<span class="text-danger ms-1">*</span>
						</label>
						<select class="select form-control" name="category" id="edit-parent-category" required>
							<option value="">Select parent category</option>
							{% for parent in categories %}
							<option value="{{ parent.id }}">{{ parent.name }}</option>
							{% endfor %}
						</select>
					</div>

					<!-- Name -->
					<div class="mb-3">
						<label for="edit-sub-name" class="form-label">
							Name<span class="text-danger ms-1">*</span>
						</label>
						<input type="text" class="form-control" id="edit-sub-name" name="name" required />
					</div>

					<!-- Slug -->
					<div class="mb-3">
						<label for="edit-sub-slug" class="form-label">
							Slug<span class="text-danger ms-1">*</span>
						</label>
						<input type="text" class="form-control" id="edit-sub-slug" name="slug" required />
					</div>

					<!-- Description -->
					<div class="mb-3">
						<label for="edit-sub-description" class="form-label">
							Description<span class="text-danger ms-1">*</span>
						</label>
						<textarea class="form-control" id="edit-sub-description" name="description" rows="3"
							required></textarea>
					</div>

					<!-- Status toggle -->
					<div class="mb-3">
						<div class="status-toggle d-flex justify-content-between align-items-center">
							<span class="status-label">Status</span>
							<input type="checkbox" id="edit-sub-status" name="status" class="check" />
							<label for="edit-sub-status" class="checktoggle"></label>
						</div>
					</div>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
						Cancel
					</button>
					<button type="submit" class="btn btn-primary">Save Changes</button>
				</div>
			</form>

		</div>
	</div>
</div>

<!-- /Edit Category -->
<!-- delete modal -->
<!-- Delete Subcategory Modal -->
<div class="modal fade" id="delete-subcategory-modal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="page-wrapper-new p-0">
				<div class="content p-5 px-3 text-center">
					<span class="rounded-circle d-inline-flex p-2 bg-danger-transparent mb-2">
						<i class="ti ti-trash fs-24 text-danger"></i>
					</span>
					<h4 class="fs-20 fw-bold mb-2 mt-1">Delete Sub Category</h4>
					<p class="mb-0 fs-16">Are you sure you want to delete <span id="delete-sub-name"
							class="fw-medium"></span>?</p>

					<!-- Note: action="" will be set via JS -->
					<form id="deleteSubcategoryForm" method="POST" action="">
						{% csrf_token %}
						<div class="modal-footer-btn mt-3 d-flex justify-content-center">
							<button type="button" class="btn btn-secondary fs-13 fw-medium p-2 px-3 shadow-none me-2"
								data-bs-dismiss="modal">
								Cancel
							</button>
							<button type="submit" class="btn btn-danger fs-13 fw-medium p-2 px-3">
								Yes, Delete
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>
<script>
	document.addEventListener('DOMContentLoaded', function () {
		//
		// 1) EDIT SUBCATEGORY MODAL
		//
		var editSubModal = document.getElementById('edit-subcategory-modal');
		if (editSubModal) {
			editSubModal.addEventListener('show.bs.modal', function (event) {
				// The <a class="btn-edit-subcategory"> that triggered this modal:
				var button = event.relatedTarget;

				// 1a) Read all data-* attributes from that button:
				var subId = button.getAttribute('data-id');
				var subName = button.getAttribute('data-name');
				var subSlug = button.getAttribute('data-slug');
				var subDesc = button.getAttribute('data-description');
				var subStatus = button.getAttribute('data-status');   // "true" or "false"
				var subImageUrl = button.getAttribute('data-image-url');
				var parentId = button.getAttribute('data-parent-id');

				// 1b) Grab references to each input inside the modal:
				var form = document.getElementById('editSubcategoryForm');
				var inputHiddenId = document.getElementById('edit-subcategory-id');
				var inputName = document.getElementById('edit-sub-name');
				var inputSlug = document.getElementById('edit-sub-slug');
				var inputDesc = document.getElementById('edit-sub-description');
				var inputStatus = document.getElementById('edit-sub-status');
				var inputCategory = document.getElementById('edit-parent-category');
				var currentImage = document.getElementById('edit-current-image');

				// 1c) Populate the hidden ID field (so backend can see the ID if needed):
				if (inputHiddenId) {
					inputHiddenId.value = subId;
				}

				// 1d) Populate the text inputs:
				if (inputName) {
					inputName.value = subName;
				}
				if (inputSlug) {
					inputSlug.value = subSlug;
				}
				if (inputDesc) {
					inputDesc.value = subDesc;
				}

				// 1e) Set the status checkbox:
				if (inputStatus) {
					inputStatus.checked = (subStatus === 'true');
				}

				// 1f) Set the parent-category <select>:
				if (inputCategory) {
					// Iterate through options and set selected where value === parentId
					for (var i = 0; i < inputCategory.options.length; i++) {
						if (inputCategory.options[i].value === parentId) {
							inputCategory.selectedIndex = i;
							break;
						}
					}
				}

				// 1g) Set the image preview:
				if (currentImage) {
					currentImage.src = subImageUrl || '';
				}

				// 1h) Finally: set the form’s action to the correct “edit” URL.
				//     Suppose your URL name is 'inventory:edit-subcategory' and expects <int:pk>.
				//     In Django template: {% url "inventory:edit-subcategory" 0 %}
				//     might render as "/inventory/subcategories/0/edit/".
				var editUrlTemplate = '{% url "inventory:edit-subcategory" 0 %}';
				// Replace "/0/" with "/" + subId + "/"
				var realEditUrl = editUrlTemplate.replace('/0/', '/' + subId + '/');
				form.action = realEditUrl;
			});
		}

		//
		// 2) DELETE SUBCATEGORY MODAL
		//
		var deleteSubModal = document.getElementById('delete-subcategory-modal');
		if (deleteSubModal) {
			deleteSubModal.addEventListener('show.bs.modal', function (event) {
				var button = event.relatedTarget;
				var subId = button.getAttribute('data-id');
				var subName = button.getAttribute('data-name');

				// Write the subName into the <span id="delete-sub-name">
				var namePlaceholder = document.getElementById('delete-sub-name');
				if (namePlaceholder) {
					namePlaceholder.textContent = subName;
				}

				// Set the form’s action to the correct “delete” URL:
				// Suppose your URL name is 'inventory:delete-subcategory' requiring <int:pk>.
				var form = document.getElementById('deleteSubcategoryForm');
				var deleteUrlTemplate = '{% url "inventory:delete-subcategory" 0 %}';
				var realDeleteUrl = deleteUrlTemplate.replace('/0/', '/' + subId + '/');
				form.action = realDeleteUrl;
			});
		}
	});
</script>



{%endblock%}