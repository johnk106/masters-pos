{%extends 'landing/base.html'%}
{%load static%}


{%block head%}

<title>Create product</title>
{%endblock%}


{%block body%}

<div class="page-wrapper">
	<div class="content">
		<div class="page-header">
			<div class="add-item d-flex">
				<div class="page-title">
					<h4 class="fw-bold">Create Product</h4>
					<h6>Create new product</h6>
				</div>
			</div>
			<ul class="table-top-head">
				<li>
					<a data-bs-toggle="tooltip" data-bs-placement="top" title="Refresh"><i
							class="ti ti-refresh"></i></a>
				</li>
				<li>
					<a data-bs-toggle="tooltip" data-bs-placement="top" title="Collapse" id="collapse-header"><i
							class="ti ti-chevron-up"></i></a>
				</li>
			</ul>
			<div class="page-btn mt-0">
				<a href="product-list.html" class="btn btn-secondary"><i data-feather="arrow-left" class="me-2"></i>Back
					to Product</a>
			</div>
		</div>
		<form action="{%url 'inventory:create-product'%}" method="post" enctype="multipart/form-data"
			class="add-product-form" id="create-product-form">
			{%csrf_token%}
			<div class="add-product">
				<div class="accordions-items-seperate" id="accordionSpacingExample">
					<div class="accordion-item border mb-4">
						<h2 class="accordion-header" id="headingSpacingOne">
							<div class="accordion-button collapsed bg-white" data-bs-toggle="collapse"
								data-bs-target="#SpacingOne" aria-expanded="true" aria-controls="SpacingOne">
								<div class="d-flex align-items-center justify-content-between flex-fill">
									<h5 class="d-flex align-items-center"><i data-feather="info"
											class="text-primary me-2"></i><span>Product Information</span></h5>
								</div>
							</div>
						</h2>
						<div id="SpacingOne" class="accordion-collapse collapse show"
							aria-labelledby="headingSpacingOne">
							<div class="accordion-body border-top">

								<div class="row">
									<div class="col-sm-6 col-12">
										<div class="mb-3">
											<label class="form-label">Product Name<span
													class="text-danger ms-1">*</span></label>
											<input type="text" name="name" class="form-control" required>
										</div>
									</div>
									<div class="col-sm-6 col-12">
										<div class="mb-3">
											<label class="form-label">Selling Type<span
													class="text-danger ms-1">*</span></label>
											<select class="select" name="selling_type" required>
												<option value="">Select</option>
												<option value="online">Online</option>
												<option value="pos">POS</option>
											</select>
										</div>
									</div>
								</div>
								<div class="addservice-info">
									<div class="row">
										<div class="col-sm-6 col-12">
											<div class="mb-3">
												<div class="add-newplus">
													<label class="form-label">Category<span
															class="text-danger ms-1">*</span></label>
													<a href="javascript:void(0);" data-bs-toggle="modal"
														data-bs-target="#add-category-modal"><i
															data-feather="plus-circle"
															class="plus-down-add"></i><span>Add
															New</span></a>
												</div>
												<select class="select" name="category" id="category-select" required>
													<option value="">Select</option>
													{%for category in categories%}
													<option value="{{category.id}}">{{category.name}}</option>
													{%endfor%}
												</select>
											</div>
										</div>
										<div class="col-sm-6 col-12">
											<div class="mb-3">
												<div class="add-newplus">
													<label class="form-label">Sub Category<span
															class="text-danger ms-1">*</span></label>
													<a href="javascript:void(0);" data-bs-toggle="modal"
														data-bs-target="#add-subcategory-modal" id="add-subcategory-btn" style="display: none;"><i
															data-feather="plus-circle"
															class="plus-down-add"></i><span>Add
															New</span></a>
												</div>
												<select class="select" name="sub_category" id="subcategory-select" required>
													<option value="">Select Category First</option>
													{%for category in subcategories%}
													<option value="{{category.id}}">{{category.name}}</option>
													{%endfor%}
												</select>
											</div>
										</div>
									</div>
								</div>
								<div class="add-product-new">
									<div class="row">

										<div class="col-sm-6 col-12">
											<div class="mb-3">
												<div class="add-newplus">
													<label class="form-label">Unit<span
															class="text-danger ms-1">*</span></label>
												</div>
												<select class="select" name="unit" required>
													<option value="">Select</option>
													{%for unit in units%}
													<option value="{{unit.id}}">{{unit.name}}</option>
													{%endfor%}
												</select>
											</div>
										</div>

										<div class="col-sm-6 col-12">
											<div class="mb-3">
												<label class="form-label">Purchase Price<span
														class="text-danger ms-1">*</span></label>
												<input type="number" step="0.01" name="purchase_price" class="form-control" required>
											</div>
										</div>
									</div>

									<div class="row">
										<div class="col-sm-6 col-12">
											<div class="mb-3">
												<label class="form-label">Images<span
														class="text-danger ms-1">*</span></label>
												<input type="file" name="images" multiple class="form-control">
											</div>
										</div>
									</div>
								</div>
									</div>
								</div>
								<!-- Editor -->
								<div class="col-lg-12">
									<div class="summer-description-box">
										<label class="form-label">Description</label><br>
										<textarea name="description" id="" rows="6" style="width:90%"></textarea>
										<p class="fs-14 mt-1">Maximum 60 Words</p>
									</div>
								</div>
								<!-- /Editor -->
							</div>
						</div>
					</div>
					<div class="accordion-item border mb-4">
						<h2 class="accordion-header" id="headingSpacingTwo">
							<div class="accordion-button collapsed bg-white" data-bs-toggle="collapse"
								data-bs-target="#SpacingTwo" aria-expanded="true" aria-controls="SpacingTwo">
								<div class="d-flex align-items-center justify-content-between flex-fill">
									<h5 class="d-flex align-items-center"><i data-feather="life-buoy"
											class="text-primary me-2"></i><span>Pricing & Stocks</span></h5>
								</div>
							</div>
						</h2>
						<div id="SpacingTwo" class="accordion-collapse collapse show"
							aria-labelledby="headingSpacingTwo">
							<div class="accordion-body border-top">

								<div class="tab-content" id="pills-tabContent">
									<div class="tab-pane fade show active" id="pills-home" role="tabpanel"
										aria-labelledby="pills-home-tab">
										<div class="single-product">
											<div class="row">
												<div class="col-lg-4 col-sm-6 col-12">
													<div class="mb-3">
														<label class="form-label">Quantity<span
																class="text-danger ms-1">*</span></label>
														<input type="number" name="quantity" class="form-control" required>
													</div>
												</div>
												<div class="col-lg-4 col-sm-6 col-12">
													<div class="mb-3">
														<label class="form-label">Price<span
																class="text-danger ms-1">*</span></label>
														<input type="text" name="price" class="form-control" required>
													</div>
												</div>
												<div class="col-lg-4 col-sm-6 col-12">
													<div class="mb-3">
														<label class="form-label">Tax Type<span
																class="text-danger ms-1">*</span></label>
														<select class="select" name="tax_type" required>
															<option value="">Select</option>
															<option value="exclusive">Exclusive</option>
															<option value="inclusive">Inclusive</option>
														</select>
													</div>
												</div>
												<div class="col-lg-4 col-sm-6 col-12">
													<div class="mb-3">
														<label class="form-label">Tax<span
																class="text-danger ms-1">*</span></label>
														<select class="select" name="tax" required>
															<option value="">Select</option>
															<option value="0">No Tax (0%)</option>
															<option value="18">VAT (18%)</option>
														</select>
													</div>
												</div>

												<div class="col-lg-4 col-sm-6 col-12">
													<div class="mb-3">
														<label class="form-label">Discount Type<span
																class="text-danger ms-1">*</span></label>
														<select class="select" name="discount_type" required>
															<option value="">Select</option>
															<option value="percentage">Percentage</option>
															<option value="fixed">Fixed</option>
														</select>
													</div>
												</div>
												<div class="col-lg-4 col-sm-6 col-12">
													<div class="mb-3">
														<label class="form-label">Discount Value<span
																class="text-danger ms-1">*</span></label>
														<input class="form-control" type="number" name="discount" required>
													</div>
												</div>
												<div class="col-lg-4 col-sm-6 col-12">
													<div class="mb-3">
														<label class="form-label">Quantity Alert<span
																class="text-danger ms-1">*</span></label>
														<input type="text" name="quantity_alert" class="form-control" required>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="col-lg-12">
				<div class="d-flex align-items-center justify-content-end mb-4">
					<a href="{%url 'inventory:product-list'%}"><button type="button" class="btn btn-secondary me-2">Cancel</button></a>
					<button type="submit" class="btn btn-primary" id="submit-btn">Add Product</button>
				</div>
			</div>
		</form>
	</div>
	<div class="footer d-sm-flex align-items-center justify-content-between border-top bg-white p-3">
		<p class="mb-0 text-gray-9">22025 &copy; Twoven Ecommerce. All Right Reserved</p>
		<p>Designed &amp; Developed by <a href="javascript:void(0);" class="text-primary">Twoven</a></p>
	</div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="add-category-modal">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<div class="page-title">
					<h4>Add Category</h4>
				</div>
				<button type="button" class="close bg-danger text-white fs-16" data-bs-dismiss="modal"
					aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form id="add-category-form">
				<div class="modal-body">
					<div class="mb-3">
						<label class="form-label">Category Name<span class="text-danger ms-1">*</span></label>
						<input type="text" name="name" class="form-control" id="category-name-input" required>
						<div class="text-danger mt-1" id="category-error" style="display: none;"></div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn me-2 btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary" id="save-category-btn">Add Category</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Add Subcategory Modal -->
<div class="modal fade" id="add-subcategory-modal">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<div class="page-title">
					<h4>Add Subcategory</h4>
				</div>
				<button type="button" class="close bg-danger text-white fs-16" data-bs-dismiss="modal"
					aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form id="add-subcategory-form">
				<div class="modal-body">
					<div class="mb-3">
						<label class="form-label">Subcategory Name<span class="text-danger ms-1">*</span></label>
						<input type="text" name="name" class="form-control" id="subcategory-name-input" required>
						<div class="text-danger mt-1" id="subcategory-error" style="display: none;"></div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn me-2 btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary" id="save-subcategory-btn">Add Subcategory</button>
				</div>
			</form>
		</div>
	</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('category-select');
    const subcategorySelect = document.getElementById('subcategory-select');
    const addSubcategoryBtn = document.getElementById('add-subcategory-btn');
    const submitBtn = document.getElementById('submit-btn');
    
    // Handle category change
    categorySelect.addEventListener('change', function() {
        const categoryId = this.value;
        
        if (categoryId) {
            // Show add subcategory button
            addSubcategoryBtn.style.display = 'inline-block';
            
            // Fetch subcategories for selected category
            fetch(`/dashboard/inventory/ajax/get-subcategories/?category_id=${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
                    data.subcategories.forEach(subcategory => {
                        const option = document.createElement('option');
                        option.value = subcategory.id;
                        option.textContent = subcategory.name;
                        subcategorySelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching subcategories:', error);
                });
        } else {
            // Hide add subcategory button
            addSubcategoryBtn.style.display = 'none';
            subcategorySelect.innerHTML = '<option value="">Select Category First</option>';
        }
    });
    
    // Handle add category form submission
    document.getElementById('add-category-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {
            name: formData.get('name')
        };
        
        // Disable submit button
        const saveCategoryBtn = document.getElementById('save-category-btn');
        saveCategoryBtn.disabled = true;
        submitBtn.disabled = true;
        
        fetch('/dashboard/inventory/ajax/create-category/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add new category to dropdown
                const option = document.createElement('option');
                option.value = data.category.id;
                option.textContent = data.category.name;
                option.selected = true;
                categorySelect.appendChild(option);
                
                // Trigger change event to load subcategories
                categorySelect.dispatchEvent(new Event('change'));
                
                // Close modal and reset form
                bootstrap.Modal.getInstance(document.getElementById('add-category-modal')).hide();
                document.getElementById('add-category-form').reset();
                document.getElementById('category-error').style.display = 'none';
            } else {
                // Show error
                const errorDiv = document.getElementById('category-error');
                errorDiv.textContent = data.error;
                errorDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error creating category:', error);
            const errorDiv = document.getElementById('category-error');
            errorDiv.textContent = 'An error occurred while creating the category.';
            errorDiv.style.display = 'block';
        })
        .finally(() => {
            saveCategoryBtn.disabled = false;
            submitBtn.disabled = false;
        });
    });
    
    // Handle add subcategory form submission
    document.getElementById('add-subcategory-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const categoryId = categorySelect.value;
        if (!categoryId) {
            const errorDiv = document.getElementById('subcategory-error');
            errorDiv.textContent = 'Please select a category first.';
            errorDiv.style.display = 'block';
            return;
        }
        
        const formData = new FormData(this);
        const data = {
            name: formData.get('name'),
            category_id: categoryId
        };
        
        // Disable submit button
        const saveSubcategoryBtn = document.getElementById('save-subcategory-btn');
        saveSubcategoryBtn.disabled = true;
        submitBtn.disabled = true;
        
        fetch('/dashboard/inventory/ajax/create-subcategory/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add new subcategory to dropdown
                const option = document.createElement('option');
                option.value = data.subcategory.id;
                option.textContent = data.subcategory.name;
                option.selected = true;
                subcategorySelect.appendChild(option);
                
                // Close modal and reset form
                bootstrap.Modal.getInstance(document.getElementById('add-subcategory-modal')).hide();
                document.getElementById('add-subcategory-form').reset();
                document.getElementById('subcategory-error').style.display = 'none';
            } else {
                // Show error
                const errorDiv = document.getElementById('subcategory-error');
                errorDiv.textContent = data.error;
                errorDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error creating subcategory:', error);
            const errorDiv = document.getElementById('subcategory-error');
            errorDiv.textContent = 'An error occurred while creating the subcategory.';
            errorDiv.style.display = 'block';
        })
        .finally(() => {
            saveSubcategoryBtn.disabled = false;
            submitBtn.disabled = false;
        });
    });
    
    // Reset error messages when modals are closed
    document.getElementById('add-category-modal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('category-error').style.display = 'none';
        document.getElementById('add-category-form').reset();
    });
    
    document.getElementById('add-subcategory-modal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('subcategory-error').style.display = 'none';
        document.getElementById('add-subcategory-form').reset();
    });
});
</script>

{%endblock%}